// Simple yet flexible JSON editor plugin.
// Turns any element into a stylable interactive JSON editor.
// Copyright (c) 2011 David Durman
// Licensed under the MIT license (http://www.opensource.org/licenses/mit-license.php).
// Dependencies:
// * jQuery
// * JSON (use json2 library for browsers that do not support JSON natively)
// Example:
//     var myjson = { any: { json: { value: 1 } } };
//     var opt = { change: function() { /* called on every change */ } };
//     /* opt.propertyElement = '<textarea>'; */ // element of the property field, <input> is default
//     /* opt.valueElement = '<textarea>'; */  // element of the value field, <input> is default
//     $('#mydiv').jsonEditor(myjson, opt);
(function(e){function t(t,n,r,i,s){var o={target:t,onchange:r,original:n,propertyElement:i,valueElement:s};p(o,n,o.target),e(".property, .value",o.target).on("blur focus",function(){e(this).toggleClass("editing")})}function n(e){return Object.prototype.toString.call(e)=="[object Object]"}function r(e){return Object.prototype.toString.call(e)=="[object Array]"}function i(e){return Object.prototype.toString.call(e)=="[object Boolean]"}function s(e){return Object.prototype.toString.call(e)=="[object Number]"}function o(e){return Object.prototype.toString.call(e)=="[object String]"}function u(e,t,n){var r=arguments.length==2;if(t.indexOf(".")>-1){var i=e,s=0,o=t.split(".");for(var u=o.length;s<u-1;s++)i=i[o[s]];r?delete i[o[u-1]]:i[o[u-1]]=n}else r?delete e[t]:e[t]=n;return e}function a(e,t,n){t=t.split(".");var r=0;while(r<t.length)if((e=e[t[r++]])==undefined)return n;return e}function f(e){window.console&&console.error(e)}function l(e){var t;try{t=JSON.parse(e)}catch(n){t=null,f("JSON parse failed.")}return t}function c(e){var t;try{t=JSON.stringify(e)}catch(n){t="null",f("JSON stringify failed.")}return t}function h(t){if(t.children(".expander").length==0){var n=e("<span>",{"class":"expander"});n.bind("click",function(){var t=e(this).parent();t.toggleClass("expanded")}),t.prepend(n)}}function p(t,i,s,o){o=o||"",s.children(".item").remove();for(var u in i){if(!i.hasOwnProperty(u))continue;var a=e("<div>",{"class":"item","data-path":o}),f=e(t.propertyElement||"<input>",{"class":"property"}),l=e(t.valueElement||"<input>",{"class":"value"});(n(i[u])||r(i[u]))&&h(a),a.append(f).append(l),s.append(a),f.val(u).attr("title",u);var v=c(i[u]);l.val(v).attr("title",v),y(a,i[u]),f.change(m(t)),l.change(g(t)),(n(i[u])||r(i[u]))&&p(t,i[u],a,(o?o+".":"")+u)}(n(i)||r(i))&&d(t,i,s,o)}function d(t,i,s,o){var u=e("<div>",{"class":"item"}),a=e(t.propertyElement||"<span>"),f=e(t.valueElement||"<a>");f.attr("href","#"),f.html("&#8627; new value"),a.append(f),u.append(a),s.append(u),f.click(function(e){e.preventDefault(),r(i)&&i.push(null);if(n(i)){var u=1,a="";for(;;){a="newKey"+u;if(!i.hasOwnProperty(a))break;u++}i[a]=null}p(t,i,s,o),t.onchange(t.original)})}function v(t,n){e(t).parentsUntil(n.target).each(function(){var t=e(this).data("path");t=(t?t+".":t)+e(this).children(".property").val();var r=c(a(n.original,t,null));e(this).children(".value").val(r).attr("title",r)})}function m(t){return function(){var n=e(this).parent().data("path"),r=l(e(this).next().val()),i=e(this).val(),s=e(this).attr("title");e(this).attr("title",i),u(t.original,(n?n+".":"")+s),i&&u(t.original,(n?n+".":"")+i,r),v(this,t),i||e(this).parent().remove(),t.onchange(t.original)}}function g(t){return function(){var i=e(this).prev().val(),s=l(e(this).val()||"null"),o=e(this).parent(),a=o.data("path");u(t.original,(a?a+".":"")+i,s),n(s)||r(s)?(p(t,s,o,(a?a+".":"")+i),h(o)):o.find(".expander, .item").remove(),y(o,s),v(this,t),t.onchange(t.original)}}function y(e,t){var u="null";n(t)?u="object":r(t)?u="array":i(t)?u="boolean":o(t)?u="string":s(t)&&(u="number"),e.removeClass(b),e.addClass(u)}e.fn.jsonEditor=function(n,r){r=r||{};var i=function(){},s=r.onchange||i;return this.each(function(){t(e(this),n,s,r.propertyElement,r.valueElement)})};var b="object array boolean number string null"})(jQuery);